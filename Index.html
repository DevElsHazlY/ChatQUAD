<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChatQUAD</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">   
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script> 
  <style>
:root {
  --bg-dark: #343541;
  --bg-light: #ffffff;
  --text-light: #e5e5e5;
  --text-dark: #2f2f2f;
  --accent: #10a37f;
  --accent-hover: #0d8a6c;
  --sidebar: #202123;
  --sidebar-hover: #2a2b32;
  --border: #3c3f4a;
  --user-msg: #2f2f3a;
  --bot-msg: #40414f;
  --error: #ef4444;
  --success: #22c55e;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  transition: background-color 0.3s, color 0.3s;
}

body {
  display: flex;
  height: 100vh;
  background-color: var(--bg-dark);
  color: var(--text-light);
  overflow: hidden;
}

.sidebar {
  width: 280px;
  background-color: var(--sidebar);
  padding: 1rem;
  display: flex;
  flex-direction: column;
  border-left: 1px solid var(--border);
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
  z-index: 10;
  overflow: hidden;
}

.app-title {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 15px 10px;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}

.app-title h1 {
  font-size: 1.5rem;
  font-weight: 600;
  background: linear-gradient(90deg, #10a37f, #3b82f6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.app-title i {
  color: var(--accent);
  font-size: 1.8rem;
}

.new-chat-btn {
  background: var(--accent);
  color: white;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  margin-bottom: 1rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}

.new-chat-btn:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.chat-list {
  flex: 1;
  overflow-y: auto;
  padding: 5px;
  margin-bottom: 1rem;
}

.chat-item {
  padding: 12px;
  margin-bottom: 8px;
  background-color: #2a2b32;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.chat-item:hover {
  background-color: var(--sidebar-hover);
}

.chat-item.active {
  background: linear-gradient(90deg, var(--accent), #2a2b32);
  border-left: 3px solid white;
}

.chat-item .delete-btn {
  color: #ef4444;
  padding: 5px;
  display: none;
}

.chat-item:hover .delete-btn {
  display: block;
}

.sidebar-footer {
  border-top: 1px solid var(--border);
  padding-top: 1rem;
}

.clear-btn {
  background: none;
  color: var(--text-light);
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}

.clear-btn:hover {
  background-color: rgba(239, 68, 68, 0.2);
  color: var(--error);
}

.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background-color: var(--bg-dark);
  position: relative;
}

.chat-header {
  padding: 1.2rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background-color: rgba(32, 33, 35, 0.7);
  backdrop-filter: blur(10px);
  z-index: 5;
}

.chat-title {
  font-size: 1.3rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

.chat-title i {
  color: var(--accent);
}

.theme-toggle {
  background: var(--sidebar);
  border: none;
  color: var(--text-light);
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
}

.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
  background: linear-gradient(rgba(52, 53, 65, 0.9), rgba(52, 53, 65, 0.9)),
              url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23202223"/><path d="M0 50 L100 50 M50 0 L50 100" stroke="%233c3f4a" stroke-width="1"/></svg>');
  background-size: 40px 40px;
}

.welcome-message {
  text-align: center;
  max-width: 600px;
  margin: 2rem auto;
  padding: 2rem;
  border-radius: 16px;
  background: rgba(32, 33, 35, 0.6);
  backdrop-filter: blur(10px);
  animation: fadeIn 0.5s ease-out;
}

.features {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.feature {
  background: rgba(59, 130, 246, 0.1);
  padding: 1.2rem;
  border-radius: 12px;
  text-align: center;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.feature i {
  font-size: 2rem;
  color: #3b82f6;
  margin-bottom: 0.8rem;
}

.message {
  max-width: 85%;
  margin-bottom: 0.5rem;
  padding: 16px 20px;
  border-radius: 16px;
  line-height: 1.5;
  display: flex;
  gap: 15px;
  animation: slideIn 0.3s ease-out;
}

.message.user {
  background-color: var(--user-msg);
  align-self: flex-end;
  border-bottom-right-radius: 5px;
}

.message.bot {
  background-color: var(--bot-msg);
  align-self: flex-start;
  border-bottom-left-radius: 5px;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 1.2rem;
}

.message.user .avatar {
  background: linear-gradient(135deg, #8b5cf6, #ec4899);
  color: white;
}

.message.bot .avatar {
  background: linear-gradient(135deg, #10a37f, #3b82f6);
  color: white;
}

.message-time {
  font-size: 0.75rem;
  color: #9ca3af;
  margin-top: 8px;
  text-align: right;
}

.chat-input {
  border-top: 2px solid var(--border);
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  background-color: rgba(32, 33, 35, 0.7);
  backdrop-filter: blur(10px);
}

.input-container {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
}

textarea {
  width: 100%;
  padding: 14px 50px 14px 20px;
  resize: none;
  border-radius: 12px;
  border: 2px solid var(--border);
  font-size: 1rem;
  background: #40414f;
  color: white;
  min-height: 60px;
  max-height: 150px;
  transition: all 0.2s;
}

textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.3);
}

.input-icons {
  position: absolute;
  right: 15px;
  display: flex;
  gap: 12px;
}

.input-icon {
  color: #9ca3af;
  cursor: pointer;
  font-size: 1.2rem;
  transition: color 0.2s;
}

.input-icon:hover {
  color: var(--accent);
}

.send-btn {
  background-color: var(--accent);
  padding: 14px 18px;
  border-radius: 12px;
  cursor: pointer;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.send-btn:hover {
  background: var(--accent-hover);
  transform: scale(1.05);
}

.send-btn:active {
  transform: scale(0.95);
}

.typing-indicator {
  display: inline-block;
  margin-left: 5px;
}

.typing-indicator span {
  display: inline-block;
  width: 8px;
  height: 8px;
  margin: 0 2px;
  background: #ccc;
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out both;
}

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

body.light-mode {
  --bg-dark: #f9fafb;
  --bg-light: #ffffff;
  --text-light: #1f2937;
  --text-dark: #4b5563;
  --sidebar: #ffffff;
  --border: #e5e7eb;
  --user-msg: #dbeafe;
  --bot-msg: #e5e7eb;
  --sidebar-hover: #f3f4f6;
}

body.light-mode .chat-area {
  background: linear-gradient(rgba(249, 250, 251, 0.9), rgba(249, 250, 251, 0.9)),
              url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23ffffff"/><path d="M0 50 L100 50 M50 0 L50 100" stroke="%23e5e7eb" stroke-width="1"/></svg>');
}

body.light-mode textarea {
  background: white;
  color: #1f2937;
  border: 2px solid #e5e7eb;
}

@media (max-width: 900px) {
  .sidebar {
    position: absolute;
    left: -280px;
    height: 100%;
    transition: transform 0.3s ease;
    z-index: 100;
  }

  .sidebar.active {
    transform: translateX(280px);
  }

  .menu-toggle {
    display: block !important;
    position: absolute;
    top: 20px;
    left: 20px;
    background: var(--sidebar);
    border: none;
    color: var(--text-light);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 101;
  }

  .close-sidebar {
    display: block !important;
    position: absolute;
    top: 15px;
    left: 15px;
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 1.5rem;
    cursor: pointer;
  }

  .features {
    grid-template-columns: 1fr;
  }

  .message {
    max-width: 95%;
  }
}

.menu-toggle {
  display: none;
}

.close-sidebar {
  display: none;
}
  </style>
</head>
<body>
  <button class="menu-toggle">
    <i class="fas fa-bars"></i>
  </button>
  <div class="sidebar">
    <div class="close-sidebar">
      <i class="fas fa-times"></i>
    </div>
    <div class="app-title">
      <i class="fas fa-robot"></i>
      <h1>ChatQUAD</h1>
    </div>
    <div class="new-chat-btn" onclick="ChatManager.startNewChat()">
      <i class="fas fa-plus"></i>
      Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©
    </div>
    <div class="chat-list" id="chatList"></div>
    <div class="sidebar-footer">
      <div class="clear-btn" onclick="ChatManager.clearAllChats()">
        <i class="fas fa-trash"></i>
        Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
      </div>
    </div>
  </div>
  <div class="main">
    <div class="chat-header">
      <div class="chat-title">
        <i class="fas fa-comment-dots"></i>
        <span id="currentChatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
      </div>
      <button class="theme-toggle" onclick="ChatManager.toggleTheme()">
        <i class="fas fa-moon"></i>
        Mode
      </button>
    </div>
    <div class="chat-area" id="chatArea">
      <div class="welcome-message">
        <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ ChatQUAD</h2>
        <p>Ù‡Ø°Ø§ Ù†Ù…ÙˆØ°Ø¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ØªÙ‚Ø¯Ù… ÙŠØ¯Ø¹Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø§Ø³ØªØ¦Ù†Ø§Ù Ù…Ø­Ø§Ø¯Ø«Ø© Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.</p>
        <div class="features">
          <div class="feature">
            <i class="fas fa-bolt"></i>
            <h3>Ø³Ø±ÙŠØ¹ ÙˆÙØ¹Ø§Ù„</h3>
            <p>Ø±Ø¯ÙˆØ¯ ÙÙˆØ±ÙŠØ© Ø¨ÙØ¶Ù„ ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</p>
          </div>
          <div class="feature">
            <i class="fas fa-shield-alt"></i>
            <h3>Ø¢Ù…Ù† ÙˆØ®Ø§Øµ</h3>
            <p>Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ Ù…Ø´ÙØ±Ø© ÙˆÙ…Ø®Ø²Ù†Ø© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†</p>
          </div>
          <div class="feature">
            <i class="fas fa-brain"></i>
            <h3>Ø°ÙƒÙŠ ÙˆØªÙƒÙŠÙÙŠ</h3>
            <p>ÙŠØªØ¹Ù„Ù… Ù…Ù† ØªÙØ§Ø¹Ù„Ø§ØªÙƒ Ù„ØªÙ‚Ø¯ÙŠÙ… ØªØ¬Ø±Ø¨Ø© Ø£ÙØ¶Ù„</p>
          </div>
        </div>
      </div>
    </div>
    <div class="chat-input">
      <div class="input-container">
        <textarea id="messageInput" placeholder="" onkeydown="handleKeyDown(event)"></textarea>
        <div class="input-icons">
          <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="ChatManager.handleImageUpload(event)">
          <label for="imageInput" style="cursor: pointer;">
            <i class="fas fa-paperclip input-icon" title="Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„ØªØµÙ†ÙŠÙ"></i>
          </label>
          <i class="fas fa-microphone input-icon" id="micBtn" title="Ù†Ø·Ù‚ Ø¨Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†"></i>
        </div>
      </div>
      <div class="send-btn" onclick="ChatManager.sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </div>
    </div>
  </div>

<script type="text/javascript">
  (function () {
    const STORAGE_KEY = 'chats_quad_4o';
    const THEME_KEY = 'light_mode_quad_4o';
    const DEEPSEEK_API_KEY = "sk-a93bfe0fe7c74da8a84e665f7a00e4a9"; // ğŸ”¥ YOUR API KEY
    let chats = [];
    let currentChatIndex = -1;
    let isLightMode = false;
    let model = null;

    function $(selector) { return document.querySelector(selector); }
    function $$(selector) { return document.querySelectorAll(selector); }
    function getCurrentTime() {
      const d = new Date();
      return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
    }

    const ChatManager = {
      init() {
        this.loadChatsFromStorage();
        this.restoreTheme();
        this.renderChatList();
        this.renderMessages();
        this.setupEventListeners();
      },
      loadChatsFromStorage() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          try {
            chats = JSON.parse(stored);
            currentChatIndex = chats.length > 0 ? 0 : -1;
          } catch (e) {
            chats = [];
            currentChatIndex = -1;
          }
        } else {
          chats = [];
          currentChatIndex = -1;
        }
      },
      saveChatsToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
      },
      restoreTheme() {
        isLightMode = localStorage.getItem(THEME_KEY) === 'true';
        if (isLightMode) {
          document.body.classList.add('light-mode');
          $('.theme-toggle').innerHTML = '<i class="fas fa-sun"></i> Mode';
        } else {
          document.body.classList.remove('light-mode');
          $('.theme-toggle').innerHTML = '<i class="fas fa-moon"></i> Mode';
        }
      },
      renderChatList() {
        const list = $('#chatList');
        list.innerHTML = '';
        if (chats.length === 0) {
          list.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>';
          return;
        }
        chats.forEach((chat, i) => {
          const item = document.createElement('div');
          item.className = `chat-item ${i === currentChatIndex ? 'active' : ''}`;
          item.innerHTML = `
            <div>${chat.title || `Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ${i + 1}`}</div>
            <i class="fas fa-trash delete-btn" title="Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©" data-index="${i}"></i>
          `;
          item.onclick = () => this.loadChat(i);
          list.appendChild(item);
        });
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§
        $$('.delete-btn').forEach(btn => {
          btn.onclick = (e) => {
            e.stopPropagation();
            const idx = parseInt(btn.getAttribute('data-index'));
            this.deleteChat(idx);
          };
        });
      },
      loadChat(index) {
        currentChatIndex = index;
        this.renderChatList();
        this.renderMessages();
        $('#currentChatTitle').textContent = chats[currentChatIndex].title || `Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ${currentChatIndex + 1}`;
      },
      deleteChat(index) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')) return;
        chats.splice(index, 1);
        if (currentChatIndex >= index) {
          currentChatIndex = Math.min(Math.max(currentChatIndex - 1, 0), chats.length - 1);
        }
        if (chats.length === 0) currentChatIndex = -1;
        this.saveChatsToStorage();
        this.renderChatList();
        this.renderMessages();
      },
      clearAllChats() {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§ØªØŸ')) return;
        chats = [];
        currentChatIndex = -1;
        this.saveChatsToStorage();
        this.renderChatList();
        this.renderMessages();
      },
      renderMessages() {
        const area = $('#chatArea');
        area.innerHTML = '';
        if (currentChatIndex === -1 || !chats[currentChatIndex]) {
          const welcome = $('.welcome-message');
          if (welcome) {
            area.appendChild(welcome.cloneNode(true));
          } else {
            area.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„</div>';
          }
          $('#currentChatTitle').textContent = 'ChatQUAD 4o';
          return;
        }
        const chat = chats[currentChatIndex];
        $('#currentChatTitle').textContent = chat.title || `Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ${currentChatIndex + 1}`;
        chat.messages.forEach(msg => {
          const msgEl = document.createElement('div');
          msgEl.className = `message ${msg.sender}`;
          msgEl.innerHTML = `
            <div class="avatar"><i class="fas ${msg.sender === 'user' ? 'fa-user' : 'fa-robot'}"></i></div>
            <div class="message-content">${msg.text}<div class="message-time">${msg.time}</div></div>
          `;
          area.appendChild(msgEl);
        });
        area.scrollTop = area.scrollHeight;
      },
      sendMessage() {
        const input = $('#messageInput');
        const text = input.value.trim();
        if (!text) return;
        if (currentChatIndex === -1) {
          chats.push({
            title: text.length > 25 ? text.substring(0, 25) + '...' : text,
            messages: []
          });
          currentChatIndex = chats.length - 1;
        }
        const userMsg = {
          sender: 'user',
          text,
          time: getCurrentTime()
        };
        chats[currentChatIndex].messages.push(userMsg);
        this.renderMessages();
        input.value = '';
        this.saveChatsToStorage();
        this.renderChatList();
        this.sendToDeepSeek(text); // ğŸ”¥ CALL TO API
      },
      async sendToDeepSeek(userText) {
        const area = $('#chatArea');
        const typing = document.createElement('div');
        typing.className = 'message bot typing-message';
        typing.innerHTML = `
          <div class="avatar"><i class="fas fa-robot"></i></div>
          <div class="message-content">
            <div class="typing-indicator">
              <span></span><span></span><span></span>
            </div>
          </div>
        `;
        area.appendChild(typing);
        area.scrollTop = area.scrollHeight;
        try {
          const response = await fetch("https://api.paxsenix.biz.id/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [
          { role: "user", content: userText }
        ],
        temperature: 0.5,
        max_tokens: 150
      })
    });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          let botReply = "";
          if (data.choices && data.choices.length > 0) {
            if (data.choices[0].text) {
              botReply = data.choices[0].text.trim();
            } else if (data.choices[0].message && data.choices[0].message.content) {
              botReply = data.choices[0].message.content.trim();
            }
          }
          if (!botReply) botReply = "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø¢Ù†.";
          area.removeChild(typing);
          const botMsg = {
            sender: 'bot',
            text: botReply,
            time: getCurrentTime()
          };
          chats[currentChatIndex].messages.push(botMsg);
          this.saveChatsToStorage();
          this.renderMessages();
        } catch (error) {
          console.error("Error calling DeepSeek:", error);
          area.removeChild(typing);
          const errorMsg = {
            sender: 'bot',
            text: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.",
            time: getCurrentTime()
          };
          chats[currentChatIndex].messages.push(errorMsg);
          this.renderMessages();
        }
      },
      startNewChat() {
        const title = `Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ${chats.length + 1}`;
        chats.push({ title, messages: [] });
        currentChatIndex = chats.length - 1;
        this.saveChatsToStorage();
        this.renderChatList();
        this.renderMessages();
        if (window.innerWidth <= 900) $('.sidebar').classList.remove('active');
      },
      toggleTheme() {
        isLightMode = !isLightMode;
        document.body.classList.toggle('light-mode', isLightMode);
        localStorage.setItem(THEME_KEY, isLightMode);
        $('.theme-toggle').innerHTML = isLightMode ?
          '<i class="fas fa-sun"></i> Mode' :
          '<i class="fas fa-moon"></i> Mode';
      },
      toggleSidebar() {
        $('.sidebar').classList.toggle('active');
      },
      setupEventListeners() {
        window.onload = () => this.init();
        $('#messageInput').addEventListener('keydown', e => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });
        $('.menu-toggle')?.addEventListener('click', this.toggleSidebar.bind(this));
        $('.close-sidebar')?.addEventListener('click', this.toggleSidebar.bind(this));
        $('.theme-toggle')?.addEventListener('click', this.toggleTheme.bind(this));

        // Speech Recognition
        this.initSpeechRecognition();

      },

      // ğŸ‘‡ Speech to Text
      initSpeechRecognition() {
        const micBtn = $('#micBtn');
        if (!micBtn) return;

        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          console.warn("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ.");
          micBtn.style.display = 'none';
          return;
        }

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ar-SA'; // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        let isListening = false;

        micBtn.addEventListener('click', () => {
          if (isListening) {
            recognition.stop();
            micBtn.style.color = '#9ca3af';
          } else {
            recognition.start();
            micBtn.style.color = '#ef4444';
          }
          isListening = !isListening;
        });

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript.trim();
          const input = $('#messageInput');
          input.value = transcript;
          ChatManager.sendMessage(); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
          micBtn.style.color = '#9ca3af';
          isListening = false;
        };

        recognition.onerror = (event) => {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª:', event.error);
          micBtn.style.color = '#9ca3af';
          isListening = false;
        };

        recognition.onend = () => {
          micBtn.style.color = '#9ca3af';
          isListening = false;
        };
      },

      // ğŸ‘‡ Image Upload & Classification
      handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.onload = async () => {
            this.showTypingIndicator();

            const userMsg = {
              sender: 'user',
              text: `<img src="${img.src}" style="max-width: 300px; border-radius: 8px;">`,
              time: getCurrentTime()
            };
            chats[currentChatIndex].messages.push(userMsg);
            this.renderMessages();

            try {
              if (!model) {
                model = await mobilenet.load();
              }

              const prediction = await model.classify(img);
              const top = prediction[0];
              const resultText = `ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©: ${top.className} (Ø¯Ù‚Ø©: ${Math.round(top.probability * 100)}%)`;

              const botMsg = {
                sender: 'bot',
                text: resultText,
                time: getCurrentTime()
              };
              chats[currentChatIndex].messages.push(botMsg);

            } catch (err) {
              const botMsg = {
                sender: 'bot',
                text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.',
                time: getCurrentTime()
              };
              chats[currentChatIndex].messages.push(botMsg);
            }

            this.saveChatsToStorage();
            this.renderMessages();
          };
        };
        reader.readAsDataURL(file);
      },

      showTypingIndicator() {
        const area = $('#chatArea');
        const typing = document.createElement('div');
        typing.className = 'message bot typing-message';
        typing.innerHTML = `
          <div class="avatar"><i class="fas fa-robot"></i></div>
          <div class="message-content">
            <div class="typing-indicator">
              <span></span><span></span><span></span>
            </div>
          </div>
        `;
        area.appendChild(typing);
        area.scrollTop = area.scrollHeight;
      }

    };

    window.ChatManager = ChatManager;
  })();
</script>
</body>
</html>
